<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Unraid下虚拟DSM7.1，并开启相册人脸识别</title>
    <link href="/2023/02/17/Unraid%E4%B8%8B%E8%99%9A%E6%8B%9FDSM7-1%EF%BC%8C%E5%B9%B6%E5%BC%80%E5%90%AF%E7%9B%B8%E5%86%8C%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/"/>
    <url>/2023/02/17/Unraid%E4%B8%8B%E8%99%9A%E6%8B%9FDSM7-1%EF%BC%8C%E5%B9%B6%E5%BC%80%E5%90%AF%E7%9B%B8%E5%86%8C%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="Unraid下虚拟DSM7-1，并开启相册人脸识别"><a href="#Unraid下虚拟DSM7-1，并开启相册人脸识别" class="headerlink" title="Unraid下虚拟DSM7.1，并开启相册人脸识别"></a>Unraid下虚拟DSM7.1，并开启相册人脸识别</h1><p><strong><font color="red">风险提示！！！请勿直接应用于生产环境或者单一数据存储环境，当前仅为测试版本！！！数据无价，请务必做好数据备份！！！</font></strong></p><p><strong><font color="red">风险提示！！！请勿直接应用于生产环境或者单一数据存储环境，当前仅为测试版本！！！数据无价，请务必做好数据备份！！！</font></strong></p><p><strong><font color="red">风险提示！！！请勿直接应用于生产环境或者单一数据存储环境，当前仅为测试版本！！！数据无价，请务必做好数据备份！！！</font></strong></p><h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>由于主机换新，之前的旧设备闲置也是闲置，于是参考 <a href="https://space.bilibili.com/28457/">Unraid 教父——司波图</a>一系列教程搭建了一台 Unraid 系统的 NAS。之前四盘位的 J3455 蜗牛星际也快满了，并且性能远远低于换代下来的 i5 8500，正好将内容迁移到 Unraid 上。但是群晖的相册套件说实话简单上手好用，还自带人脸识别，所以还是打算在 Unraid 上虚拟一个黑群晖，专门用于相册的备份和维护。废话不多说，下面开始干货。</p><h2 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a>二、配置</h2><table><thead><tr><th align="left"></th><th align="right"></th></tr></thead><tbody><tr><td align="left">sys</td><td align="right">Unraid 6.10.3</td></tr><tr><td align="left">cpu</td><td align="right">Intel® Core™ i5-8500 CPU @ 3.00GHz</td></tr><tr><td align="left">主板</td><td align="right">Gigabyte Technology Co., Ltd. B360M AORUS Gaming 3-CF</td></tr><tr><td align="left">内存</td><td align="right">DDR4 -  24G 普条</td></tr><tr><td align="left">硬盘</td><td align="right">希捷 ST18000NM013J_ZR56YQB9 - 18 TB<br />西数 SN570 -1TB</td></tr></tbody></table><p>基本配置如上，其中西数的 SN570 作为 cache 使用，无校验盘。“亡命之徒”本徒了。</p><p><strong><font color="red">注意：如果需要添加校验盘，则校验盘容量必须大于等于阵列中单硬盘最大容量，以上配置就需要一个 18T 的硬盘作为校验盘。没有校验盘时，重要资料务必多地备份！</font></strong></p><h2 id="三、准备事项"><a href="#三、准备事项" class="headerlink" title="三、准备事项"></a>三、准备事项</h2><p><strong>以下内容都是基于 DSM918+ 7.1.0 展开，其余设备型号或者版本因精力有限未做尝试！</strong></p><ol><li>准备一个 tinycore-redpill 的基础镜像（tinycore-redpill-uefi.v0.8.0.0.img）：<a href="https://github.com/pocopico/tinycore-redpill">https://github.com/pocopico/tinycore-redpill</a></li><li>准备 DSM918+ 7.1.0patch 文件：<a href="https://cndl.synology.cn/download/DSM/release/7.1/42661-1/DSM_DS918%2B_42661.pat">https://cndl.synology.cn/download/DSM/release/7.1/42661-1/DSM_DS918%2B_42661.pat</a></li><li>主板 bios 打开核显（安装过程中发现，核显被设置为自动，当有独显时，核显默认不开，会导致 Unraid 无法获取核显信息，<strong>Intel GVT-g</strong> 插件无法使用）</li><li>ssh 工具，如 xshell，putty，MobaXterm 等</li></ol><h2 id="四、创建虚拟-DSM-流程"><a href="#四、创建虚拟-DSM-流程" class="headerlink" title="四、创建虚拟 DSM 流程"></a>四、创建虚拟 DSM 流程</h2><p><mark><font color="red">再次提醒！！！务必做好数据备份，在无需担心数据损失的前提下进行以下操作！！！</font></mark></p><p><mark><font color="red">再次提醒！！！务必做好数据备份，在无需担心数据损失的前提下进行以下操作！！！</font></mark></p><p><mark><font color="red">再次提醒！！！务必做好数据备份，在无需担心数据损失的前提下进行以下操作！！！</font></mark></p><h3 id="1、创建虚拟机"><a href="#1、创建虚拟机" class="headerlink" title="1、创建虚拟机"></a>1、创建虚拟机</h3><p>创建虚拟机的基本步骤请参考——<a href="https://www.bilibili.com/video/BV1R7411s7gP?spm_id_from=333.999.0.0">unRaid 下黑群晖，Freenas，OMV 的安装方法——司波图 UNRAID 陪玩教程 05</a>。</p><p>最新的创建参数和大佬的有些差别：</p><ol><li>Machine：Q35-6.2</li><li>BIOS：OVMF（tinycore 选择 UEFI 镜像）</li><li>USB Controller：3.0(qemu XHCI)</li><li>Primary vDisk 选择我们事先拷贝到 isos 目录下的镜像文件（tinycore-redpill-uefi.v0.8.0.0.img），并选择 USB 模式</li><li>添加第二块 vDisk，此处设置为 sata 模式，其余按需设置即可</li><li>网卡设置为 e1000</li><li>取消勾选“Start VM after creation”</li></ol><p>此时已基本完成虚拟机相关设置，如下图所示：</p><p><img src="https://user-images.githubusercontent.com/35327600/180962087-4ce99534-f44e-4cf7-bb9e-26dc5148f248.png"></p><p>创建后，重新编辑虚拟机，打开 xml 模式，修改以下红框内划线处 <code>controller = &quot;0&quot;</code> 为 <code>controller = &quot;1&quot;</code>。</p><p><img src="https://user-images.githubusercontent.com/35327600/180955218-2dc76d15-879c-4f12-b029-1f90cf0ca5b8.png"></p><p>本人在尝试了无数次卡重新安装 pat 的死循环后，最终在 xp 论坛上找到了解决方案。就是这个 sata disk 的 controller 索引错误导致无法找到 sata 磁盘控制信息，从而卡在安装 pat 文件错误的死循环中。原贴链接：<a href="https://xpenology.com/forum/topic/63333-tutorial-install-dsm-71-on-unraid-6103/#comment-287607">https://xpenology.com/forum/topic/63333-tutorial-install-dsm-71-on-unraid-6103/#comment-287607</a></p><p>整体安装 DSM 的流程也可参考原贴。</p><h3 id="2、创建完整引导镜像"><a href="#2、创建完整引导镜像" class="headerlink" title="2、创建完整引导镜像"></a>2、创建完整引导镜像</h3><ol><li><p>开启虚拟机，并开启 VNC，看到如下界面：</p><p><img src="https://user-images.githubusercontent.com/35327600/180959772-e0ea5062-238d-4e65-a9f0-db37e77e379e.png"></p><p>按照图片中描述操作，获取当前虚拟机 ip 地址</p></li><li><p>通过 ssh 工具进行连接虚拟机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh tc@192.168.2.191<br>&lt;输入密码：P@ssw0rd&gt;<br><br>Connecting to 192.168.2.191:22...<br>Connection established.<br>To escape to local shell, press &#x27;Ctrl+Alt+]&#x27;.<br><br>WARNING! The remote SSH server rejected X11 forwarding request.<br>   ( &#x27;&gt;&#x27;)<br>  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.<br> (/-_--_-\)           www.tinycorelinux.net<br><br>tc@box:~$ <br></code></pre></td></tr></table></figure></li><li><p>依次无脑执行以下命令，命令执行过程中会有部分内容需要手动确定，有 yY 输 y，无 yY 直接回车</p><ul><li><code>./rploader.sh update now</code></li><li><code>./rploader.sh fullupgrade now</code></li><li><code>./rploader.sh serialgen DS918+</code></li><li><code>./rploader.sh satamap now</code></li><li><code>./rploader.sh identifyusb now</code></li><li><code>./rploader.sh ext apollolake-7.1.0-42661 add https://raw.githubusercontent.com/pocopico/rp-ext/master/e1000/rpext-index.json</code></li><li><code>./rploader.sh build apollolake-7.1.0-42661</code></li></ul><p>执行最后一个命令时，可能会有红色日志提示，内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[!] Extension is already added (index exists at /home/tc/redpill-load/custom/extensions/pocopico.e1000/pocopico.e1000.json). For more info use &quot;ext-manager.sh info pocopico.e1000&quot;<br>*** Process will exit ***<br></code></pre></td></tr></table></figure><p>该提示目前使用下来无影响，出现如下打印，表示镜像构建成功：</p><p><img src="https://user-images.githubusercontent.com/35327600/180965299-4c8231d4-a541-4275-b167-0ba521330ab8.png"></p></li><li><p>关闭虚拟机，打开 xml 编辑，查看之前修改的 <code>controller = &quot;1&quot;</code> 是否又变回默认值 <code>&quot;0&quot;</code>。如果发生改变，请再一次手动更改为 <code>&quot;1&quot;</code>，否则将无法正确安装 pat 文件。</p></li></ol><h3 id="3、创建-DSM7-1"><a href="#3、创建-DSM7-1" class="headerlink" title="3、创建 DSM7.1"></a>3、创建 DSM7.1</h3><p>启动虚拟机，并在 VNC 中手动选择 USB 引导。（起始界面还有一个 SATA 引导，未进行测试，喜欢折腾可以试试）</p><p>后续就和常规安装群晖一样，使用浏览器访问 <a href="https://finds.synology.com/%EF%BC%8C%E8%8E%B7%E5%8F%96%E6%96%B0%E5%AE%89%E8%A3%85%E7%9A%84">https://finds.synology.com/，获取新安装的</a> DSM 信息，上传 pat 文件进行安装。</p><p><img src="https://user-images.githubusercontent.com/35327600/180968642-5e580051-e9a7-4e82-be03-267eadf2e1b0.png"></p><p>恭喜，DSM 7.1 至此已完成完整的安装！接下来的基本操作就不在赘述了，按照指引正常处理就行。</p><h2 id="五、开启相册人脸识别"><a href="#五、开启相册人脸识别" class="headerlink" title="五、开启相册人脸识别"></a>五、开启相册人脸识别</h2><p>按照上述流程创建的群晖是无法开启相册套件中的人脸识别功能，因为核显没有直通给群晖，导致群晖无法调用核显进行人脸识别。我们需要借助“<strong>Intel GVT-g</strong>”插件虚拟化核显，并配置给我们的群晖虚拟机。</p><ol><li><p>配置好群晖后，关闭虚拟机</p></li><li><p>在 Unraid APP 市场中安装插件 <strong>Intel GVT-g</strong></p></li><li><p>在 PLUGINS 界面中打开 <strong>Intel GVT-g</strong> 配置</p></li><li><p>根据当前虚拟显存的模式，分配给群晖虚拟机，确定后点击 “ASSIGN VM”</p><p><img src="https://user-images.githubusercontent.com/35327600/180971454-d802c4c7-6050-452f-b954-d1bc4e8a3375.png"></p></li><li><p>回到虚拟机的 xml 配置进行修改，安装时的 <code>controller = &quot;1&quot;</code> 还是需要注意的地方。其余部分按下图进行修改：</p><p><img src="https://user-images.githubusercontent.com/35327600/180977569-0c9566b4-8ab8-4232-89d8-a39959387c5a.png"></p><p>找到 xml 中新增的 &lt;hostdev&gt;，将其中的 <code>bus = &#39;0x01&#39; slot=&#39;0x00&#39;</code> 修改为 <code>bus = &#39;0x00&#39; slot=&#39;0x02&#39;</code>，这是因为虚拟化后核显的地址默认为 <code>0000:00:02.0</code></p><p>由于我们将虚拟化核显的总线（bus）和设备号（slot）修改了，和 xml 中部分原有配置产生冲突，因此需要将其余 <code>bus = &#39;0x00&#39; slot=&#39;0x02&#39;</code> 所在的行删除，如下图所示：</p><p><img src="https://user-images.githubusercontent.com/35327600/180977611-5185c30b-d8d6-43d6-94c8-b6dfc9714bfd.png"></p></li><li><p>修改完成后，重启群晖虚拟机，在 <code>控制面板-&gt;终端机和SNMP</code> 中打开 ssh 功能。使用 ssh 工具进行连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">输入：ls /dev/dri<br>显示：card0  renderD128<br></code></pre></td></tr></table></figure></li></ol><p>如果能正常显示上述内容，如果不是设备特殊，此时应该已经能进行人脸识别，我们测试一下</p><h2 id="六、人脸识别功能测试"><a href="#六、人脸识别功能测试" class="headerlink" title="六、人脸识别功能测试"></a>六、人脸识别功能测试</h2><p>在套件中心搜索关键词“photo”，下载安装完成后打开，点击右上角用户图标，在设置中“启用个人空间人物相册”</p><p><img src="https://user-images.githubusercontent.com/35327600/180982129-913020e6-c84d-4f68-9292-c982bc34b2c2.png"></p><p>找几张图上传，等一段时间后，查看一下人物相册，是否根据人脸识别自动创建了对应的相册，如果正确创建了，那么恭喜！</p><p><img src="https://user-images.githubusercontent.com/35327600/181008438-89e5df3b-ec6e-4bad-ab56-56d63161810a.png"></p><h2 id="七、参考链接"><a href="#七、参考链接" class="headerlink" title="七、参考链接"></a>七、参考链接</h2><ul><li>pocopico 大佬的 github：<a href="https://github.com/pocopico/tinycore-redpill">https://github.com/pocopico/tinycore-redpill</a></li><li>xpenology 论坛：<a href="https://xpenology.com/forum/topic/63333-tutorial-install-dsm-71-on-unraid-6103/#comment-287607">https://xpenology.com/forum/topic/63333-tutorial-install-dsm-71-on-unraid-6103/#comment-287607</a></li><li>Jinlife 大佬博客：<a href="https://blog.jinlife.com/index.php/archives/49/">https://blog.jinlife.com/index.php/archives/49/</a></li><li>张大妈：<a href="https://post.smzdm.com/p/a5dl2808/">https://post.smzdm.com/p/a5dl2808/</a></li><li>司波图 B 站教程视频：<a href="https://space.bilibili.com/28457/channel/seriesdetail?sid=896368">https://space.bilibili.com/28457/channel/seriesdetail?sid=896368</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>unRAID</category>
      
    </categories>
    
    
    <tags>
      
      <tag>折腾日记</tag>
      
      <tag>原创</tag>
      
      <tag>unRAID</tag>
      
      <tag>DSM7.1</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/1970/01/01/hello-world/"/>
    <url>/1970/01/01/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
